<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Draw Counting Line - People Counter Web</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: #f8f9fa;
      }
      .navbar {
        background: linear-gradient(135deg, #4158d0 0%, #c850c0 100%);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .canvas-container {
        position: relative;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        background: #fff;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      #videoCanvas {
        border: 3px solid #4158d0;
        border-radius: 12px;
        cursor: crosshair;
        max-width: 100%;
        height: auto;
        transition: all 0.3s ease;
      }
      #videoCanvas:hover {
        border-color: #c850c0;
      }
      .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      }
      .card-header {
        background: linear-gradient(135deg, #4158d0 0%, #c850c0 100%);
        color: white;
        border-radius: 15px 15px 0 0 !important;
      }
      .point-counter {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 30px;
        font-size: 14px;
        font-weight: 500;
        z-index: 100;
      }
      .instructions {
        background: rgba(255, 255, 255, 0.95);
        border-left: 4px solid #4158d0;
        padding: 15px;
        border-radius: 0 8px 8px 0;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .step {
        display: flex;
        align-items: center;
        margin: 10px 0;
        opacity: 0.7;
        transition: opacity 0.3s;
      }
      .step.active {
        opacity: 1;
      }
      .step-number {
        width: 24px;
        height: 24px;
        background: #4158d0;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-size: 12px;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container">
        <a class="navbar-brand" href="/">People Counter Web</a>
      </div>
    </nav>

    <div class="container mt-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Draw Counting Line</h5>
        </div>
        <div class="card-body">
          <div class="instructions">
            <h6 class="mb-3">
              <i class="fas fa-info-circle me-2"></i>Hướng dẫn vẽ đường đếm và
              hướng di chuyển
            </h6>
            <div class="step" id="step1">
              <div class="step-number">1</div>
              <span>Click điểm 1: Đầu đường đếm (màu đỏ)</span>
            </div>
            <div class="step" id="step2">
              <div class="step-number">2</div>
              <span>Click điểm 2: Cuối đường đếm (màu đỏ)</span>
            </div>
            <div class="step" id="step3">
              <div class="step-number">3</div>
              <span>Click điểm 3: Hướng đi VÀO (màu xanh)</span>
            </div>
            <div class="step" id="step4">
              <div class="step-number">4</div>
              <span>Click điểm 4: Hướng đi RA (màu đỏ)</span>
            </div>
          </div>

          <div class="text-center">
            <canvas id="videoCanvas"></canvas>
            <div class="point-counter">
              <span id="clickCount">0</span>/4 điểm đã chọn
            </div>
          </div>

          <div class="mt-4 text-center">
            <div class="btn-group" role="group">
              <button
                type="button"
                class="btn btn-success"
                id="startBtn"
                disabled
              >
                <i class="fas fa-play me-2"></i>Bắt đầu ngay
              </button>
              <button type="button" class="btn btn-warning" id="clearBtn">
                <i class="fas fa-undo me-2"></i>Xóa điểm vẽ lại
              </button>
            </div>
            <div class="mt-2">
              <small class="text-muted">
                <i class="fas fa-info-circle me-1"></i>
                <strong>Bắt buộc phải có đầy đủ 4 điểm</strong> để bắt đầu đếm
                người với hướng di chuyển
              </small>
            </div>
          </div>

          <form id="lineForm" action="/set_line" method="post" class="d-none">
            <input type="hidden" name="filename" value="{{ filename }}" />
            <input type="hidden" name="x1" id="x1" />
            <input type="hidden" name="y1" id="y1" />
            <input type="hidden" name="x2" id="x2" />
            <input type="hidden" name="y2" id="y2" />
            <input type="hidden" name="x3" id="x3" />
            <input type="hidden" name="y3" id="y3" />
            <input type="hidden" name="x4" id="x4" />
            <input type="hidden" name="y4" id="y4" />
          </form>

          <div class="mt-3">
            <div class="alert alert-info">
              <h6><i class="fas fa-lightbulb me-2"></i>Giải thích:</h6>
              <ul class="mb-0">
                <li>
                  <strong>Đường đếm (đỏ):</strong> Đường thẳng để đếm người đi
                  qua
                </li>
                <li>
                  <strong>Điểm 3 (xanh):</strong> Hướng đi VÀO - người đi từ
                  điểm 3 sẽ được đếm +1
                </li>
                <li>
                  <strong>Điểm 4 (đỏ):</strong> Hướng đi RA - người đi từ điểm 4
                  sẽ được đếm -1
                </li>
                <li>
                  Hệ thống sẽ so sánh hướng di chuyển với 2 hướng này để xác
                  định chiều
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // huỳnh
      document.addEventListener("DOMContentLoaded", function () {
        const canvas = document.getElementById("videoCanvas");
        const ctx = canvas.getContext("2d");
        let clicks = [];

        // Hiển thị frame đầu tiên từ backend
        const img = new Image();
        img.onload = function () {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
        };

        // Sử dụng frame đã được xử lý từ backend
        img.src = "data:image/jpeg;base64,{{ frame_data }}";

        // Function to draw arrow
        function drawArrow(ctx, fromX, fromY, toX, toY, color = "#28a745") {
          const headlen = 15;
          const angle = Math.atan2(toY - fromY, toX - fromX);

          // Draw line
          ctx.beginPath();
          ctx.moveTo(fromX, fromY);
          ctx.lineTo(toX, toY);
          ctx.strokeStyle = color;
          ctx.lineWidth = 3;
          ctx.stroke();

          // Draw arrow head
          ctx.beginPath();
          ctx.moveTo(toX, toY);
          ctx.lineTo(
            toX - headlen * Math.cos(angle - Math.PI / 6),
            toY - headlen * Math.sin(angle - Math.PI / 6)
          );
          ctx.moveTo(toX, toY);
          ctx.lineTo(
            toX - headlen * Math.cos(angle + Math.PI / 6),
            toY - headlen * Math.sin(angle + Math.PI / 6)
          );
          ctx.strokeStyle = color;
          ctx.lineWidth = 3;
          ctx.stroke();
        }

        // Function to update step indicators
        function updateSteps() {
          for (let i = 1; i <= 4; i++) {
            const step = document.getElementById(`step${i}`);
            if (i <= clicks.length) {
              step.classList.add("active");
            } else {
              step.classList.remove("active");
            }
          }
        }

        // Function to update start button state
        function updateStartButton() {
          const startBtn = document.getElementById("startBtn");
          if (clicks.length >= 4) {
            startBtn.disabled = false;
            startBtn.innerHTML = `<i class="fas fa-play me-2"></i>Bắt đầu ngay (${clicks.length}/4 điểm)`;
          } else {
            startBtn.disabled = true;
            startBtn.innerHTML = `<i class="fas fa-play me-2"></i>Bắt đầu ngay (${clicks.length}/4 điểm)`;
          }
        }

        // Function to clear canvas and reset
        function clearCanvas() {
          // Clear canvas
          ctx.clearRect(0, 0, canvas.width, canvas.height);

          // Redraw the video frame
          ctx.drawImage(img, 0, 0);

          // Reset clicks
          clicks = [];

          // Update UI
          document.getElementById("clickCount").textContent = "0";
          updateSteps();
          updateStartButton();
        }

        // Function to submit form
        function submitForm() {
          if (clicks.length >= 4) {
            // Fill form data - counting line
            document.getElementById("x1").value = Math.round(clicks[0].x);
            document.getElementById("y1").value = Math.round(clicks[0].y);
            document.getElementById("x2").value = Math.round(clicks[1].x);
            document.getElementById("y2").value = Math.round(clicks[1].y);

            // Fill direction data - required 4 points
            document.getElementById("x3").value = Math.round(clicks[2].x);
            document.getElementById("y3").value = Math.round(clicks[2].y);
            document.getElementById("x4").value = Math.round(clicks[3].x);
            document.getElementById("y4").value = Math.round(clicks[3].y);

            // Submit form
            document.getElementById("lineForm").submit();
          }
        }

        // Handle clicks
        canvas.addEventListener("click", function (e) {
          if (clicks.length >= 4) return; // Prevent more than 4 clicks

          const rect = canvas.getBoundingClientRect();
          const scaleX = canvas.width / rect.width;
          const scaleY = canvas.height / rect.height;

          const x = (e.clientX - rect.left) * scaleX;
          const y = (e.clientY - rect.top) * scaleY;

          clicks.push({ x: x, y: y });

          // Update click counter
          document.getElementById("clickCount").textContent = clicks.length;
          updateSteps();
          updateStartButton();

          // Draw point with different colors
          ctx.beginPath();
          ctx.arc(x, y, 6, 0, 2 * Math.PI);
          if (clicks.length <= 2) {
            ctx.fillStyle = "#dc3545"; // Red for counting line
          } else if (clicks.length === 3) {
            ctx.fillStyle = "#28a745"; // Green for direction IN
          } else {
            ctx.fillStyle = "#dc3545"; // Red for direction OUT
          }
          ctx.fill();

          // Add white border
          ctx.beginPath();
          ctx.arc(x, y, 6, 0, 2 * Math.PI);
          ctx.strokeStyle = "white";
          ctx.lineWidth = 2;
          ctx.stroke();

          // Draw counting line (red) after 2 points
          if (clicks.length === 2) {
            ctx.beginPath();
            ctx.moveTo(clicks[0].x, clicks[0].y);
            ctx.lineTo(clicks[1].x, clicks[1].y);
            ctx.strokeStyle = "#dc3545";
            ctx.lineWidth = 4;
            ctx.stroke();
          }

          // Draw direction arrows after 4 points
          if (clicks.length === 4) {
            // Draw arrow from point 3 (IN direction - green)
            drawArrow(
              ctx,
              clicks[2].x,
              clicks[2].y,
              clicks[3].x,
              clicks[3].y,
              "#28a745"
            );

            // Draw arrow from point 4 (OUT direction - red)
            drawArrow(
              ctx,
              clicks[3].x,
              clicks[3].y,
              clicks[2].x,
              clicks[2].y,
              "#dc3545"
            );

            // Auto-submit is removed - user can use "Bắt đầu ngay" button
          }
        });

        // Event listeners for buttons
        document
          .getElementById("startBtn")
          .addEventListener("click", function () {
            submitForm();
          });

        document
          .getElementById("clearBtn")
          .addEventListener("click", function () {
            if (
              confirm("Bạn có chắc muốn xóa tất cả điểm đã vẽ và bắt đầu lại?")
            ) {
              clearCanvas();
            }
          });
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
