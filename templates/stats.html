<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Statistics - People Counter Web</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: #f8f9fa;
      }
      .navbar {
        background: linear-gradient(135deg, #4158d0 0%, #c850c0 100%);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        overflow: hidden;
      }
      .card-header {
        background: linear-gradient(135deg, #4158d0 0%, #c850c0 100%);
        color: white;
        border-radius: 15px 15px 0 0 !important;
        padding: 1.5rem;
      }
      .stats-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        transition: transform 0.3s;
        border: none;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      }
      .stats-card:hover {
        transform: translateY(-5px);
      }
      .stats-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin-bottom: 1rem;
      }
      .bg-gradient-primary {
        background: linear-gradient(135deg, #4158d0 0%, #c850c0 100%);
      }
      .bg-gradient-success {
        background: linear-gradient(135deg, #00c9ff 0%, #92fe9d 100%);
      }
      .bg-gradient-info {
        background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
      }
      .table-container {
        background: white;
        border-radius: 15px;
        padding: 1rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      }
      .dataTables_wrapper .dataTables_filter input {
        border: 2px solid #eee;
        border-radius: 10px;
        padding: 0.5rem 1rem;
        margin-left: 0.5rem;
      }
      .dataTables_wrapper .dataTables_filter input:focus {
        border-color: #c850c0;
        outline: none;
        box-shadow: none;
      }
      .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: linear-gradient(135deg, #4158d0 0%, #c850c0 100%);
        border: none;
        color: white !important;
        border-radius: 5px;
      }
      .chart-container {
        position: relative;
        margin: auto;
        height: 300px;
      }
      .filter-controls {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid #e9ecef;
      }
      .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 0.5rem;
      }
      .form-select,
      .form-control {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s;
      }
      .form-select:focus,
      .form-control:focus {
        border-color: #4158d0;
        box-shadow: 0 0 0 0.2rem rgba(65, 88, 208, 0.25);
      }
      .btn-outline-secondary,
      .btn-outline-primary {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s;
      }
      .btn-outline-secondary:hover {
        background-color: #6c757d;
        border-color: #6c757d;
        transform: translateY(-1px);
      }
      .btn-outline-primary:hover {
        background-color: #4158d0;
        border-color: #4158d0;
        transform: translateY(-1px);
      }
      .dropdown-menu {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-top: none;
        border-top-left-radius: 0;
        border-top-right-radius: 0;
      }
      .dropdown-item {
        padding: 0.5rem 1rem;
        transition: all 0.2s;
      }
      .dropdown-item:hover {
        background-color: #f8f9fa;
        color: #4158d0;
      }
      .dropdown-item i {
        color: #6c757d;
      }
      .dropdown-item:hover i {
        color: #4158d0;
      }
      .video-search-container {
        position: relative;
      }
      .video-search-container .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        display: none;
      }
      .video-search-container.show .dropdown-menu {
        display: block;
      }
      .dataTables_wrapper .dataTables_sorting {
        background-image: none !important;
        position: relative;
      }
      .dataTables_wrapper .dataTables_sorting:after {
        content: "↕";
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
      }
      .dataTables_wrapper .dataTables_sorting_asc:after {
        content: "↑";
        color: #4158d0;
      }
      .dataTables_wrapper .dataTables_sorting_desc:after {
        content: "↓";
        color: #4158d0;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
      <div class="container">
        <a class="navbar-brand" href="/">
          <i class="fas fa-video me-2"></i>People Counter Web
        </a>
        <div class="ms-auto">
          <a href="/" class="btn btn-outline-light">
            <i class="fas fa-home me-2"></i>Home
          </a>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="stats-card">
            <div class="stats-icon bg-gradient-primary text-white">
              <i class="fas fa-users"></i>
            </div>
            <h3 class="mb-2">{{ detailed_logs|length }}</h3>
            <p class="text-muted mb-0">Total Events</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stats-card">
            <div class="stats-icon bg-gradient-success text-white">
              <i class="fas fa-sign-in-alt"></i>
            </div>
            <h3 class="mb-2">
              {{ detailed_logs|selectattr('direction', 'equalto',
              'IN')|list|length }}
            </h3>
            <p class="text-muted mb-0">Total Incoming</p>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stats-card">
            <div class="stats-icon bg-gradient-info text-white">
              <i class="fas fa-sign-out-alt"></i>
            </div>
            <h3 class="mb-2">
              {{ detailed_logs|selectattr('direction', 'equalto',
              'OUT')|list|length }}
            </h3>
            <p class="text-muted mb-0">Total Outgoing</p>
          </div>
        </div>
      </div>

      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-chart-line me-2"></i>People Count Trend
          </h5>
        </div>
        <div class="card-body">
          <!-- Time Range Selector -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="timeRangeSelect" class="form-label">
                <i class="fas fa-clock me-2"></i>Time Range
              </label>
              <select id="timeRangeSelect" class="form-select">
                <option value="minute">By Minute</option>
                <option value="hour" selected>By Hour</option>
                <option value="day">By Day</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="chartTypeSelect" class="form-label">
                <i class="fas fa-chart-bar me-2"></i>Chart Type
              </label>
              <select id="chartTypeSelect" class="form-select">
                <option value="line" selected>Line Chart</option>
                <option value="bar">Bar Chart</option>
                <option value="area">Area Chart</option>
              </select>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="trendChart"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-table me-2"></i>Detailed Event Logs
          </h5>
        </div>
        <div class="card-body">
          <!-- Filter Controls -->
          <div class="filter-controls">
            <div class="row mb-4">
              <div class="col-md-3">
                <label for="videoFilter" class="form-label">
                  <i class="fas fa-video me-2"></i>Filter by Video
                </label>
                <div class="video-search-container">
                  <input
                    type="text"
                    id="videoSearch"
                    class="form-control"
                    placeholder="Search video name..."
                    autocomplete="off"
                  />
                  <select id="videoFilter" class="form-select d-none">
                    <option value="">All Videos</option>
                    {% for video in
                    detailed_logs|map(attribute='video_name')|unique|sort %}
                    <option value="{{ video }}">{{ video }}</option>
                    {% endfor %}
                  </select>
                  <div
                    id="videoDropdown"
                    class="dropdown-menu w-100"
                    style="max-height: 200px; overflow-y: auto"
                  >
                    {% for video in
                    detailed_logs|map(attribute='video_name')|unique|sort %}
                    <a class="dropdown-item" href="#" data-value="{{ video }}">
                      <i class="fas fa-file-video me-2"></i>{{ video }}
                    </a>
                    {% endfor %}
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <label for="directionFilter" class="form-label">
                  <i class="fas fa-arrows-alt-h me-2"></i>Filter by Direction
                </label>
                <select id="directionFilter" class="form-select">
                  <option value="">All Directions</option>
                  <option value="IN">IN</option>
                  <option value="OUT">OUT</option>
                </select>
              </div>
              <div class="col-md-3">
                <label for="dateFromFilter" class="form-label">
                  <i class="fas fa-calendar me-2"></i>From Date
                </label>
                <input
                  type="datetime-local"
                  id="dateFromFilter"
                  class="form-control"
                />
              </div>
              <div class="col-md-3">
                <label for="dateToFilter" class="form-label">
                  <i class="fas fa-calendar me-2"></i>To Date
                </label>
                <input
                  type="datetime-local"
                  id="dateToFilter"
                  class="form-control"
                />
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-12">
                <button id="clearFilters" class="btn btn-outline-secondary">
                  <i class="fas fa-times me-2"></i>Clear All Filters
                </button>
                <button
                  id="exportFiltered"
                  class="btn btn-outline-primary ms-2"
                >
                  <i class="fas fa-download me-2"></i>Export Filtered Data
                </button>
              </div>
            </div>
          </div>
          {% if detailed_logs %}
          <div class="table-container">
            <table id="detailedLogsTable" class="table table-striped">
              <thead>
                <tr>
                  <th>DateTime</th>
                  <th>Video Name</th>
                  <th>Track ID</th>
                  <th>Direction</th>
                </tr>
              </thead>
              <tbody>
                {% for log in detailed_logs %}
                <tr>
                  <td data-sort="{{ log.datetime }}">
                    <i class="fas fa-clock text-muted me-2"></i>
                    {{ log.datetime }}
                  </td>
                  <td>
                    <i class="fas fa-file-video text-primary me-2"></i>
                    {{ log.video_name }}
                  </td>
                  <td>
                    <span class="badge bg-secondary">{{ log.track_id }}</span>
                  </td>
                  <td>
                    {% if log.direction == 'IN' %}
                    <span class="badge bg-success">
                      <i class="fas fa-arrow-right me-1"></i>IN
                    </span>
                    {% else %}
                    <span class="badge bg-danger">
                      <i class="fas fa-arrow-left me-1"></i>OUT
                    </span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
            <p class="text-muted">No detailed logs available yet.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <script>
      let chartInstance = null;
      let detailedLogs = {{ detailed_logs|tojson|safe }};

      function formatTimeKey(date, timeRange) {
        const d = new Date(date);
        switch(timeRange) {
          case 'minute':
            return d.toISOString().slice(0, 16); // YYYY-MM-DDTHH:MM
          case 'hour':
            return d.toISOString().slice(0, 13) + ':00'; // YYYY-MM-DDTHH:00
          case 'day':
            return d.toISOString().slice(0, 10); // YYYY-MM-DD
          default:
            return d.toISOString().slice(0, 10);
        }
      }

      function groupDataByTimeRange(logs, timeRange) {
        const timeCounts = {};

        logs.forEach(log => {
          const timeKey = formatTimeKey(log.datetime, timeRange);
          if (!timeCounts[timeKey]) {
            timeCounts[timeKey] = { in: 0, out: 0, total: 0 };
          }
          if (log.direction === 'IN') {
            timeCounts[timeKey].in++;
          } else {
            timeCounts[timeKey].out++;
          }
          timeCounts[timeKey].total++;
        });

        return timeCounts;
      }

      function updateChart() {
        const timeRange = document.getElementById('timeRangeSelect').value;
        const chartType = document.getElementById('chartTypeSelect').value;

        const timeCounts = groupDataByTimeRange(detailedLogs, timeRange);
        const timeKeys = Object.keys(timeCounts).sort();

        const inData = timeKeys.map(key => timeCounts[key].in);
        const outData = timeKeys.map(key => timeCounts[key].out);
        const totalData = timeKeys.map(key => timeCounts[key].total);

        // Format labels based on time range
        let formattedLabels = timeKeys;
        if (timeRange === 'minute') {
          formattedLabels = timeKeys.map(key => {
            const d = new Date(key);
            return d.toLocaleString('vi-VN', {
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          });
        } else if (timeRange === 'hour') {
          formattedLabels = timeKeys.map(key => {
            const d = new Date(key);
            return d.toLocaleString('vi-VN', {
              month: 'short',
              day: 'numeric',
              hour: '2-digit'
            });
          });
        } else if (timeRange === 'day') {
          formattedLabels = timeKeys.map(key => {
            const d = new Date(key);
            return d.toLocaleDateString('vi-VN', {
              month: 'short',
              day: 'numeric'
            });
          });
        }

        const chartConfig = {
          type: chartType,
          data: {
            labels: formattedLabels,
            datasets: [{
              label: 'IN',
              data: inData,
              borderColor: '#28a745',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              tension: 0.4,
              fill: chartType === 'area'
            }, {
              label: 'OUT',
              data: outData,
              borderColor: '#dc3545',
              backgroundColor: 'rgba(220, 53, 69, 0.1)',
              tension: 0.4,
              fill: chartType === 'area'
            }, {
              label: 'Total',
              data: totalData,
              borderColor: '#4158D0',
              backgroundColor: 'rgba(65, 88, 208, 0.1)',
              tension: 0.4,
              fill: chartType === 'area'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true
              },
              title: {
                display: true,
                text: `People Count Trend - ${timeRange.charAt(0).toUpperCase() + timeRange.slice(1)} View`
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: 'Number of People'
                }
              },
              x: {
                title: {
                  display: true,
                  text: timeRange === 'minute' ? 'Time (Minute)' :
                        timeRange === 'hour' ? 'Time (Hour)' : 'Date'
                }
              }
            }
          }
        };

        if (chartInstance) {
          chartInstance.destroy();
        }

        chartInstance = new Chart(document.getElementById('trendChart'), chartConfig);
      }

      document.addEventListener('DOMContentLoaded', function() {
          {% if detailed_logs %}
          if (document.getElementById('trendChart')) {
              // Initialize chart
              updateChart();

              // Add event listeners for controls
              document.getElementById('timeRangeSelect').addEventListener('change', updateChart);
              document.getElementById('chartTypeSelect').addEventListener('change', updateChart);
          }
          {% endif %}
      });
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      let dataTable;
      let allData = {{ detailed_logs|tojson|safe }};

      $(document).ready(function () {

        // Initialize DataTable
        dataTable = $("#detailedLogsTable").DataTable({
          order: [[0, "desc"]], // Sort by datetime by default
          pageLength: 25,
          language: {
            search: "Search:",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
          },
          columnDefs: [
            {
              targets: [0], // DateTime column
              type: "date"
            },
            {
              targets: [1], // Video Name column
              type: "string",
              render: function(data, type, row) {
                if (type === 'sort' || type === 'type') {
                  // Extract video name from HTML content
                  return data.replace(/<[^>]*>/g, '').trim();
                }
                return data;
              }
            },
            {
              targets: [2], // Track ID column
              type: "num",
              render: function(data, type, row) {
                if (type === 'sort' || type === 'type') {
                  return parseInt(data) || 0;
                }
                return data;
              }
            },
            {
              targets: [3], // Direction column
              type: "string",
              render: function(data, type, row) {
                if (type === 'sort' || type === 'type') {
                  // Extract direction from badge
                  return $(data).find('.badge').text().trim();
                }
                return data;
              }
            }
          ],
          processing: true,
          responsive: true
        });

        // Video search functionality
        function initializeVideoSearch() {
          const videoSearch = $("#videoSearch");
          const videoDropdown = $("#videoDropdown");
          const videoContainer = $(".video-search-container");
          const allVideoItems = videoDropdown.find(".dropdown-item");

          videoSearch.on('input', function() {
            const searchTerm = $(this).val().toLowerCase();

            if (searchTerm.length > 0) {
              videoContainer.addClass('show');

              allVideoItems.each(function() {
                const videoName = $(this).text().toLowerCase();
                if (videoName.includes(searchTerm)) {
                  $(this).show();
                } else {
                  $(this).hide();
                }
              });
            } else {
              videoContainer.removeClass('show');
              allVideoItems.show();
            }

            // Apply filter after a short delay to avoid too many calls
            clearTimeout(window.videoSearchTimeout);
            window.videoSearchTimeout = setTimeout(function() {
              applyFilters();
            }, 300);
          });

          videoSearch.on('focus', function() {
            if ($(this).val().length > 0) {
              videoContainer.addClass('show');
            }
          });

          // Handle dropdown item selection
          videoDropdown.on('click', '.dropdown-item', function(e) {
            e.preventDefault();
            const videoName = $(this).data('value');
            videoSearch.val(videoName);
            videoContainer.removeClass('show');
            applyFilters();
          });

          // Close dropdown when clicking outside
          $(document).on('click', function(e) {
            if (!videoContainer.is(e.target) && videoContainer.has(e.target).length === 0) {
              videoContainer.removeClass('show');
            }
          });
        }

        // Filter functionality
        function applyFilters() {
          const videoFilter = $("#videoSearch").val();
          const directionFilter = $("#directionFilter").val();
          const dateFromFilter = $("#dateFromFilter").val();
          const dateToFilter = $("#dateToFilter").val();

          // Clear all existing filters first
          dataTable.search('').columns().search('');
          // Remove all custom search functions
          while ($.fn.dataTable.ext.search.length > 0) {
            $.fn.dataTable.ext.search.pop();
          }

          // Apply video filter - search in video name column
          if (videoFilter) {
            dataTable.column(1).search(videoFilter, false, false);
          }

          // Apply direction filter - search in direction column
          if (directionFilter) {
            dataTable.column(3).search(directionFilter, false, false);
          }

          // Apply date filtering
          if (dateFromFilter || dateToFilter) {
            $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
              const dateStr = data[0].replace(/<[^>]*>/g, '').trim(); // Remove HTML tags
              const eventDate = new Date(dateStr);

              if (dateFromFilter && eventDate < new Date(dateFromFilter)) {
                return false;
              }
              if (dateToFilter && eventDate > new Date(dateToFilter)) {
                return false;
              }
              return true;
            });
          }

          dataTable.draw();
          updateStats();
        }

        // Update statistics based on filtered data
        function updateStats() {
          const filteredData = dataTable.rows({search: 'applied'}).data().toArray();
          const totalEvents = filteredData.length;

          let totalIn = 0;
          let totalOut = 0;

          filteredData.forEach(row => {
            // Get direction from the HTML content
            const directionCell = row[3];
            const directionText = $(directionCell).find('.badge').text().trim();

            if (directionText === 'IN') {
              totalIn++;
            } else if (directionText === 'OUT') {
              totalOut++;
            }
          });

          // Update stats cards
          $('.stats-card h3').eq(0).text(totalEvents);
          $('.stats-card h3').eq(1).text(totalIn);
          $('.stats-card h3').eq(2).text(totalOut);
        }

        // Initialize video search
        initializeVideoSearch();

        // Event listeners
        $("#directionFilter, #dateFromFilter, #dateToFilter").on('change', applyFilters);

        $("#clearFilters").on('click', function() {
          // Clear all filter inputs
          $("#videoSearch, #directionFilter, #dateFromFilter, #dateToFilter").val('');
          $(".video-search-container").removeClass('show');
          $("#videoDropdown .dropdown-item").show();

          // Clear all DataTable filters
          dataTable.search('').columns().search('');
          // Remove all custom search functions
          while ($.fn.dataTable.ext.search.length > 0) {
            $.fn.dataTable.ext.search.pop();
          }
          dataTable.draw();

          updateStats();
        });

        $("#exportFiltered").on('click', function() {
          const filteredData = dataTable.rows({search: 'applied'}).data().toArray();
          let csvContent = "DateTime,Video Name,Track ID,Direction\n";

          filteredData.forEach(row => {
            // Clean HTML tags from each cell
            const datetime = $(row[0]).text().trim();
            const videoName = $(row[1]).text().trim();
            const trackId = $(row[2]).text().trim();
            const direction = $(row[3]).find('.badge').text().trim();

            csvContent += `"${datetime}","${videoName}","${trackId}","${direction}"\n`;
          });

          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'filtered_logs.csv';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        });

        // Initialize stats
        updateStats();
      });
    </script>
  </body>
</html>
